openapi: 3.0.3
info:
  title: Play Integrity Guard - API Extension
  description: |
    Extension to the CloudPrep Mobile API for Play Integrity token verification.

    This adds a single endpoint to the existing NestJS backend. The endpoint
    acts as a pass-through proxy: it receives an encrypted Play Integrity token
    from the mobile app, decrypts it via Google's API, and returns the verdict.

    The backend performs NO enforcement — the mobile app evaluates the verdict
    and decides whether to allow or block access.

    **Existing API**: See `specs/002-cloudprep-mobile/contracts/api.yaml`
  version: 1.0.0
  contact:
    name: CloudPrep Team

servers:
  - url: https://api.cloudprep.app
    description: Production
  - url: http://localhost:3000
    description: Development

tags:
  - name: Integrity
    description: Play Integrity verification (mobile app only)

paths:
  /api/integrity/verify:
    post:
      tags: [Integrity]
      operationId: verifyIntegrityToken
      summary: Decrypt and return Play Integrity verdict
      description: |
        Receives an encrypted Play Integrity token from the mobile app,
        sends it to Google's Play Integrity API for decryption, and returns
        the decoded verdict payload.

        The backend does NOT enforce the verdict — it acts as a decryption
        proxy only. The mobile app evaluates the verdict client-side.

        Rate-limited by the existing RateLimitMiddleware.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyIntegrityRequest'
            example:
              token: 'eyJhbGciOiJBMjU2S1ciLCJlbmMiOiJBMjU2R0NNIn0...'
      responses:
        '200':
          description: Decrypted integrity verdict from Google
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityVerdictResponse'
              example:
                requestDetails:
                  requestPackageName: 'com.dojoexam.cloudprep'
                  timestampMillis: '1707800000000'
                appIntegrity:
                  appRecognitionVerdict: 'PLAY_RECOGNIZED'
                  packageName: 'com.dojoexam.cloudprep'
                  versionCode: '1'
                deviceIntegrity:
                  deviceRecognitionVerdict:
                    - 'MEETS_DEVICE_INTEGRITY'
                accountDetails:
                  appLicensingVerdict: 'LICENSED'
        '400':
          description: Missing or invalid token in request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                statusCode: 400
                message: 'Token is required'
                error: 'Bad Request'
        '502':
          description: Google Play Integrity API returned an error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                statusCode: 502
                message: 'Failed to verify integrity token with Google'
                error: 'Bad Gateway'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    VerifyIntegrityRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          description: |
            The encrypted integrity token received from `react-native-google-play-integrity`
            `requestIntegrityToken()` call on the client.
          minLength: 1

    IntegrityVerdictResponse:
      type: object
      description: |
        The decrypted verdict payload from Google's Play Integrity API.
        See https://developer.android.com/google/play/integrity/verdicts
      properties:
        requestDetails:
          type: object
          properties:
            requestPackageName:
              type: string
              description: Package name the attestation was requested for
            timestampMillis:
              type: string
              description: Timestamp when the integrity token was requested
            nonce:
              type: string
              description: Nonce (classic requests only)
            requestHash:
              type: string
              description: Request hash (standard requests only)
        appIntegrity:
          type: object
          properties:
            appRecognitionVerdict:
              type: string
              enum: [PLAY_RECOGNIZED, UNRECOGNIZED_VERSION, UNEVALUATED]
              description: Whether the app is recognized by Google Play
            packageName:
              type: string
              description: Package name of the app
            certificateSha256Digest:
              type: array
              items:
                type: string
              description: SHA256 digest of app certificates
            versionCode:
              type: string
              description: Version code of the app
        deviceIntegrity:
          type: object
          properties:
            deviceRecognitionVerdict:
              type: array
              items:
                type: string
                enum:
                  [
                    MEETS_DEVICE_INTEGRITY,
                    MEETS_BASIC_INTEGRITY,
                    MEETS_STRONG_INTEGRITY,
                  ]
              description: Device integrity labels
        accountDetails:
          type: object
          properties:
            appLicensingVerdict:
              type: string
              enum: [LICENSED, UNLICENSED, UNEVALUATED]
              description: Whether the user has a Play license for the app

    ErrorResponse:
      type: object
      properties:
        statusCode:
          type: integer
        message:
          type: string
        error:
          type: string
