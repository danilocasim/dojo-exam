openapi: 3.0.3
info:
  title: CloudPrep Mobile - API
  description: |
    Multi-tenant API for CloudPrep Mobile applications.

    Supports multiple certification exam types (AWS CCP, Solutions Architect, etc.).
    Each mobile app is configured with a specific examType.

    **Public Endpoints** (mobile app):
    - Exam type configuration (domain weights, passing score)
    - Question bank delivery (read-only, filtered by examType)
    - Version checking for sync (per examType)

    **Admin Endpoints** (admin portal):
    - Question CRUD operations (per examType)
    - Exam type management
    - Approval workflow
    - Content management

    **Phase 2 Endpoints** (authentication & cloud sync, NEW):
    - Google OAuth sign-in and token management
    - Exam attempt submission and history retrieval
    - Server-side analytics aggregation
  version: 1.2.0
  contact:
    name: CloudPrep Team

servers:
  - url: https://api.cloudprep.app/v1
    description: Production
  - url: http://localhost:3000/v1
    description: Development

tags:
  - name: Public
    description: Mobile app endpoints (no auth required)
  - name: Admin
    description: Admin portal endpoints (auth required)
  - name: Auth
    description: Authentication endpoints (Google OAuth, JWT) - Phase 2
  - name: ExamAttempts
    description: Exam submission and analytics endpoints - Phase 2

paths:
  /exam-types/{examTypeId}:
    get:
      tags: [Public]
      operationId: getExamType
      summary: Get exam type configuration
      description: |
        Returns exam type metadata including domain definitions, passing score,
        time limit, and question count. Mobile apps call this on first launch
        and periodically to get updated exam configuration.
      parameters:
        - name: examTypeId
          in: path
          required: true
          description: Exam type identifier (e.g., aws-ccp, aws-saa)
          schema:
            type: string
            example: aws-ccp
      responses:
        '200':
          description: Exam type configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExamTypeResponse'
        '404':
          description: Exam type not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /exam-types/{examTypeId}/questions:
    get:
      tags: [Public]
      operationId: getQuestions
      summary: Get question bank updates for exam type
      description: |
        Returns questions for the specified exam type, updated since the specified version.
        If no version is provided, returns the full question bank.
        Questions are returned in version order (oldest first).
      parameters:
        - name: examTypeId
          in: path
          required: true
          description: Exam type identifier (e.g., aws-ccp, aws-saa)
          schema:
            type: string
            example: aws-ccp
        - name: since
          in: query
          description: Return questions with version greater than this value
          required: false
          schema:
            type: integer
            minimum: 0
            example: 42
        - name: limit
          in: query
          description: Maximum number of questions to return (default 100, max 500)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
      responses:
        '200':
          description: Question bank data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestionBankResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Exam type not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /exam-types/{examTypeId}/questions/version:
    get:
      tags: [Public]
      operationId: getLatestVersion
      summary: Get latest question bank version for exam type
      description: |
        Returns the current latest version number for the specified exam type.
        Use this to check if updates are available before fetching questions.
      parameters:
        - name: examTypeId
          in: path
          required: true
          description: Exam type identifier (e.g., aws-ccp, aws-saa)
          schema:
            type: string
            example: aws-ccp
      responses:
        '200':
          description: Version information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionResponse'
        '404':
          description: Exam type not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      tags: [Public]
      operationId: healthCheck
      summary: API health check
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok]
                  timestamp:
                    type: string
                    format: date-time

  # Admin Endpoints
  /admin/exam-types:
    get:
      tags: [Admin]
      operationId: listExamTypes
      summary: List all exam types
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of exam types
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ExamTypeResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/questions:
    get:
      tags: [Admin]
      operationId: listQuestions
      summary: List all questions (with filters)
      security:
        - bearerAuth: []
      parameters:
        - name: examTypeId
          in: query
          required: true
          description: Filter by exam type
          schema:
            type: string
            example: aws-ccp
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, pending, approved, archived]
        - name: domain
          in: query
          description: Domain ID (must be valid for the exam type)
          schema:
            type: string
        - name: difficulty
          in: query
          schema:
            type: string
            enum: [easy, medium, hard]
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: Paginated question list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminQuestionListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Admin]
      operationId: createQuestion
      summary: Create a new question
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuestionInput'
      responses:
        '201':
          description: Question created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminQuestion'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/questions/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Admin]
      operationId: getQuestion
      summary: Get question by ID
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Question details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminQuestion'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [Admin]
      operationId: updateQuestion
      summary: Update question
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuestionInput'
      responses:
        '200':
          description: Question updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminQuestion'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/questions/{id}/approve:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags: [Admin]
      operationId: approveQuestion
      summary: Approve a pending question
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Question approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminQuestion'
        '400':
          description: Question not in pending status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/questions/{id}/archive:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags: [Admin]
      operationId: archiveQuestion
      summary: Archive a question
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Question archived
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminQuestion'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/questions/{id}/restore:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags: [Admin]
      operationId: restoreQuestion
      summary: Restore an archived question
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Question restored to pending status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminQuestion'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/stats:
    get:
      tags: [Admin]
      operationId: getAdminStats
      summary: Get question bank statistics
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminStats'

  /admin/auth/login:
    post:
      tags: [Admin]
      operationId: adminLogin
      summary: Admin login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  admin:
                    $ref: '#/components/schemas/AdminUser'
        '401':
          description: Invalid credentials

  # Phase 2: Authentication & Cloud Sync Endpoints (NEW)

  /auth/google/callback:
    post:
      tags: [Auth]
      operationId: googleCallback
      summary: Google OAuth callback handler (Phase 2)
      description: |
        Exchange Google ID token for JWT. Called after user completes Google Sign-In.
        Creates or updates User record in database.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [idToken]
              properties:
                idToken:
                  type: string
                  description: ID token from Google Sign-In SDK
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    description: JWT access token (1 hour expiry)
                  refreshToken:
                    type: string
                    description: Refresh token (long-lived)
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Invalid or expired ID token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      tags: [Auth]
      operationId: getCurrentUser
      summary: Get current authenticated user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/refresh:
    post:
      tags: [Auth]
      operationId: refreshToken
      summary: Refresh JWT access token
      description: Use refresh token to obtain a new access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken:
                  type: string
      responses:
        '200':
          description: New tokens issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                  refreshToken:
                    type: string
        '401':
          description: Invalid or expired refresh token

  /auth/logout:
    post:
      tags: [Auth]
      operationId: logout
      summary: Logout current user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
        '401':
          $ref: '#/components/responses/Unauthorized'

  /exam-attempts:
    post:
      tags: [ExamAttempts]
      operationId: submitExamAttempt
      summary: Submit completed exam to cloud (Phase 2)
      description: |
        Called after user completes and submits an exam.
        Records exam attempt in database for signed-in users.
        Called by offline sync queue after connectivity restores.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                [examAttemptId, examTypeId, score, passed, answers, duration]
              properties:
                examAttemptId:
                  type: string
                  format: uuid
                  description: Mobile exam attempt ID
                examTypeId:
                  type: string
                  description: Exam type (e.g., aws-ccp)
                score:
                  type: integer
                  minimum: 0
                  maximum: 100
                  description: Exam score percentage
                passed:
                  type: boolean
                  description: Whether user passed exam
                answers:
                  type: array
                  description: User's answers to each question
                  items:
                    type: object
                    properties:
                      questionId:
                        type: string
                        format: uuid
                      selectedOptions:
                        type: array
                        items:
                          type: string
                duration:
                  type: integer
                  description: Exam duration in seconds
      responses:
        '201':
          description: Exam attempt recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExamAttempt'
        '400':
          description: Invalid exam data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    get:
      tags: [ExamAttempts]
      operationId: getExamAttempts
      summary: Get user's exam history
      security:
        - bearerAuth: []
      parameters:
        - name: examTypeId
          in: query
          description: Filter by exam type
          schema:
            type: string
        - name: page
          in: query
          description: Page number (default 1)
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Results per page (default 20, max 100)
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: Paginated exam history
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ExamAttempt'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer
                        description: Total exam attempts
        '401':
          $ref: '#/components/responses/Unauthorized'

  /exam-attempts/analytics:
    get:
      tags: [ExamAttempts]
      operationId: getAnalytics
      summary: Get analytics summary (Phase 2)
      description: |
        Server-side analytics aggregation. Returns summary statistics across
        all exam attempts for the authenticated user.
      security:
        - bearerAuth: []
      parameters:
        - name: examTypeId
          in: query
          description: Filter analytics by exam type (optional)
          schema:
            type: string
      responses:
        '200':
          description: Analytics summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  schemas:
    ExamTypeResponse:
      type: object
      required:
        - id
        - name
        - displayName
        - domains
        - passingScore
        - timeLimit
        - questionCount
        - isActive
      properties:
        id:
          type: string
          description: Unique exam type identifier
          example: 'aws-ccp'
        name:
          type: string
          description: Full exam name
          example: 'AWS Certified Cloud Practitioner'
        displayName:
          type: string
          description: Short display name
          example: 'AWS CCP'
        description:
          type: string
          nullable: true
          description: Exam description
          example: 'Entry-level AWS certification covering cloud fundamentals'
        domains:
          type: array
          items:
            $ref: '#/components/schemas/ExamDomain'
          description: List of exam domains with weights
        passingScore:
          type: integer
          minimum: 0
          maximum: 100
          description: Passing score percentage
          example: 70
        timeLimit:
          type: integer
          minimum: 1
          description: Time limit in minutes
          example: 90
        questionCount:
          type: integer
          minimum: 1
          description: Number of questions per exam
          example: 65
        isActive:
          type: boolean
          description: Whether exam type is currently active
          example: true

    ExamDomain:
      type: object
      required:
        - id
        - name
        - weight
        - questionCount
      properties:
        id:
          type: string
          description: Domain identifier
          example: 'cloud-concepts'
        name:
          type: string
          description: Domain display name
          example: 'Cloud Concepts'
        weight:
          type: integer
          minimum: 0
          maximum: 100
          description: Weight percentage in exam
          example: 24
        questionCount:
          type: integer
          minimum: 0
          description: Number of questions from this domain per exam
          example: 16

    Question:
      type: object
      required:
        - id
        - text
        - type
        - domain
        - difficulty
        - options
        - correctAnswers
        - explanation
        - version
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique question identifier
          example: '550e8400-e29b-41d4-a716-446655440000'
        text:
          type: string
          minLength: 20
          description: Question text (may include markdown)
          example: 'Which AWS service provides a virtual private cloud environment?'
        type:
          type: string
          enum: [single-choice, multiple-choice, true-false]
          description: Question type
          example: 'single-choice'
        domain:
          type: string
          description: Domain ID (must match a domain in the exam type)
          example: 'technology'
        difficulty:
          type: string
          enum: [easy, medium, hard]
          description: Question difficulty level
          example: 'medium'
        options:
          type: array
          minItems: 2
          items:
            $ref: '#/components/schemas/Option'
          description: Answer options
        correctAnswers:
          type: array
          minItems: 1
          items:
            type: string
          description: IDs of correct option(s)
          example: ['a']
        explanation:
          type: string
          minLength: 50
          description: Explanation of the correct answer
          example: 'Amazon VPC (Virtual Private Cloud) allows you to provision a logically isolated section of the AWS Cloud...'
        version:
          type: integer
          minimum: 1
          description: Question version for sync tracking
          example: 43
        createdAt:
          type: string
          format: date-time
          description: When question was created
        updatedAt:
          type: string
          format: date-time
          description: When question was last updated

    Option:
      type: object
      required:
        - id
        - text
      properties:
        id:
          type: string
          description: Option identifier (a, b, c, d, etc.)
          example: 'a'
        text:
          type: string
          description: Option text
          example: 'Amazon VPC'

    QuestionBankResponse:
      type: object
      required:
        - questions
        - latestVersion
        - hasMore
      properties:
        questions:
          type: array
          items:
            $ref: '#/components/schemas/Question'
          description: List of questions
        latestVersion:
          type: integer
          description: Latest version number in the full question bank
          example: 156
        hasMore:
          type: boolean
          description: Whether more questions are available (pagination)
          example: false
        nextSince:
          type: integer
          description: Value to use for 'since' parameter to get next page (only present if hasMore is true)
          example: 142

    VersionResponse:
      type: object
      required:
        - latestVersion
        - questionCount
      properties:
        latestVersion:
          type: integer
          description: Latest version number
          example: 156
        questionCount:
          type: integer
          description: Total number of approved questions
          example: 243
        lastUpdatedAt:
          type: string
          format: date-time
          description: When question bank was last updated

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: 'INVALID_PARAMETER'
        message:
          type: string
          description: Human-readable error message
          example: "Parameter 'since' must be a non-negative integer"

    # Admin Schemas
    QuestionInput:
      type: object
      required:
        - examTypeId
        - text
        - type
        - domain
        - difficulty
        - options
        - correctAnswers
        - explanation
      properties:
        examTypeId:
          type: string
          description: Exam type this question belongs to
          example: 'aws-ccp'
        text:
          type: string
          minLength: 20
        type:
          type: string
          enum: [single-choice, multiple-choice, true-false]
        domain:
          type: string
          description: Domain ID (must match a domain in the exam type)
          example: 'technology'
        difficulty:
          type: string
          enum: [easy, medium, hard]
        options:
          type: array
          minItems: 2
          items:
            $ref: '#/components/schemas/Option'
        correctAnswers:
          type: array
          minItems: 1
          items:
            type: string
        explanation:
          type: string
          minLength: 50

    AdminQuestion:
      allOf:
        - $ref: '#/components/schemas/Question'
        - type: object
          properties:
            status:
              type: string
              enum: [draft, pending, approved, archived]
            createdBy:
              $ref: '#/components/schemas/AdminUser'
            approvedBy:
              $ref: '#/components/schemas/AdminUser'
            approvedAt:
              type: string
              format: date-time
            archivedAt:
              type: string
              format: date-time

    AdminQuestionListResponse:
      type: object
      properties:
        questions:
          type: array
          items:
            $ref: '#/components/schemas/AdminQuestion'
        total:
          type: integer
        page:
          type: integer
        totalPages:
          type: integer

    AdminUser:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string

    AdminStats:
      type: object
      properties:
        totalQuestions:
          type: integer
        byStatus:
          type: object
          properties:
            draft:
              type: integer
            pending:
              type: integer
            approved:
              type: integer
            archived:
              type: integer
        byDomain:
          type: object
          additionalProperties:
            type: integer

    # Phase 2 Schemas (NEW)

    User:
      type: object
      description: Authenticated user from Google OAuth
      required: [id, googleId, email, createdAt]
      properties:
        id:
          type: string
          format: uuid
          description: User primary key
        googleId:
          type: string
          description: Google account ID
        email:
          type: string
          format: email
          description: User email
        name:
          type: string
          nullable: true
          description: User name from Google profile
        createdAt:
          type: string
          format: date-time
          description: Account creation time
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
          description: Last successful login

    ExamAttempt:
      type: object
      description: Exam submission record
      required: [id, examTypeId, score, passed, submittedAt]
      properties:
        id:
          type: string
          format: uuid
        examTypeId:
          type: string
          description: Exam type identifier
        score:
          type: integer
          minimum: 0
          maximum: 100
          description: Exam score percentage
        passed:
          type: boolean
          description: Whether exam was passed
        duration:
          type: integer
          description: Exam duration in seconds
        submittedAt:
          type: string
          format: date-time
          description: When exam was submitted
        syncStatus:
          type: string
          enum: [pending, synced, failed]
          description: |
            Cloud sync status:
            - pending = exam_to submitted locally but not yet sent to backend
            - synced = exam successfully persisted on backend
            - failed = backend received exam but processing encountered error

    AnalyticsSummary:
      type: object
      description: User's exam analytics summary
      properties:
        totalAttempts:
          type: integer
          description: Total exams completed
        totalPassed:
          type: integer
          description: Number of passed exams
        passRate:
          type: number
          format: double
          minimum: 0
          maximum: 1
          description: Pass rate as decimal (0-1)
        averageScore:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Average exam score
        averageDuration:
          type: integer
          description: Average exam duration in seconds
        byExamType:
          type: array
          description: Analytics broken down by exam type
          items:
            type: object
            properties:
              examTypeId:
                type: string
              attempts:
                type: integer
              passed:
                type: integer
              passRate:
                type: number
              averageScore:
                type: number
        lastAttemptAt:
          type: string
          format: date-time
          nullable: true
          description: When last exam was taken

  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ValidationError:
      description: Validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
